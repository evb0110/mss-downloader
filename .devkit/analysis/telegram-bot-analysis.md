# Telegram Bot Analysis

## Overview

The `telegram-bot` directory contains a standalone Node.js and TypeScript application that serves as a notification system for the MSS Downloader project. Its primary function is to inform subscribed users about new application builds when they are released.

## Core Technologies

-   **Runtime:** Node.js with TypeScript
-   **Main Dependency:** `node-telegram-bot-api` for interacting with the Telegram Bot API.
-   **Module System:** The project is configured to use ES Modules (`"type": "module"` in `package.json`).

## Key Files and Logic

-   **`src/multiplatform-bot.ts`:** This is the main bot logic file. The `MultiplatformMSSBot` class handles all user interactions, command processing, and subscription management.
-   **`src/bot.ts`:** The entry point for starting the bot. It instantiates and starts the `MultiplatformMSSBot`.
-   **`src/send-multiplatform-build.ts`:** This is the script responsible for sending notifications. It is designed to be called from a CI/CD environment. It finds the latest builds, generates a changelog from git commits, and uses the bot to send the message to subscribers.
-   **`subscribers.json`:** A simple JSON file that acts as the database for storing subscriber information (chat ID, username, subscribed platforms).
-   **`src/build-utils.ts`:** A utility class to find the latest build artifacts in the `release/` directory of the main project.

## How It Works

1.  **User Interaction:** Users interact with the bot on Telegram (`@abbaababusbot`). They can `/start` the bot, `/subscribe` to notifications for specific platforms (e.g., Windows AMD64, macOS), `/unsubscribe`, and get the `/latest` build.
2.  **Subscription Management:** The bot stores user `chatId` and their platform preferences in `subscribers.json`. This ensures that users only receive notifications for the platforms they are interested in.
3.  **Build Notification (CI/CD):**
    -   The process is triggered by the `.github/workflows/build-and-notify.yml` GitHub Action.
    -   After a new version is successfully built and released on GitHub, the workflow calls the `telegram:send-multiplatform-build` npm script.
    -   This script (`send-multiplatform-build.ts`) finds the newly created build artifacts, generates a changelog message by parsing recent git commits, and then uses the `MultiplatformMSSBot` to send a formatted notification to all relevant subscribers.

## Important Notes

-   **Single Instance:** The bot uses polling and can conflict if multiple instances are run simultaneously, leading to `409 Conflict` errors from the Telegram API.
-   **State Refresh:** The bot logic includes safeguards to refresh its in-memory subscriber list from `subscribers.json` before performing actions to prevent state inconsistency issues.
-   **Changelog Generation:** The changelog sent to users is dynamically generated by filtering git commit messages to exclude "technical" commits and include "user-facing" ones.
