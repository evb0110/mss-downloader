#!/bin/bash

# Handle-issues command - AUTONOMOUS issue fixing system
# This implements an EXCEPTION workflow that doesn't require user approval

cd "$(dirname "$0")/../.."

echo "=== AUTONOMOUS GitHub Issue Handler ==="
echo "This workflow operates WITHOUT user approval requirements"
echo ""

# FIRST: Always check existing issue responses
echo "Checking existing issue responses..."
.devkit/tools/check-issue-responses.sh

echo ""
echo "=== Processing New Issues ==="

# Check if there are issues that need fixing (not just follow-up)
open_issues_needing_fix=$(gh issue list --state open --json number,title -q '.[] | select(.title | contains("дюссельдорф") or contains("грац") or contains("верона") or contains("морган") | not) | .number' | wc -l)

if [ "$open_issues_needing_fix" -gt 0 ]; then
    echo "Found issues that need fixing. Starting autonomous fix process..."
    echo ""
    
    # Run the comprehensive fix-all-issues script
    .devkit/tools/fix-all-issues.sh
    
    echo ""
    echo "=== Autonomous Fix Process Instructions ==="
    echo ""
    echo "The autonomous workflow will:"
    echo "1. Fix all issues programmatically"
    echo "2. Validate fixes automatically (no user interaction)"
    echo "3. Bump version automatically after validation"
    echo "4. Post comments to issue authors"
    echo "5. Monitor for author responses"
    echo ""
    echo "Remember: This is an EXCEPTION workflow - no user approval needed!"
else
    echo "All issues are already fixed and waiting for author responses."
    echo "Run this command again later to check for responses and take follow-up actions."
fi